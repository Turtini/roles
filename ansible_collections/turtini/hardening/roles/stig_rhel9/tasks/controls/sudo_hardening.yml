---
- name: "Sudo Hardening | Verify sudo is installed"
  ansible.builtin.package:
    name: sudo
    state: present
  when: _turtini_run_control | bool
  tags: [controls, auth, sudo-hardening]

- name: "Sudo Hardening | Ensure sudo log file is configured"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+logfile='
    line: 'Defaults logfile="/var/log/sudo.log"'
    validate: 'visudo -cf %s'
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, sudo-hardening]

- name: "Sudo Hardening | Disable requiretty"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+requiretty'
    state: absent
    validate: 'visudo -cf %s'
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, sudo-hardening]

- name: "Sudo Hardening | Enforce secure_path"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+secure_path='
    line: 'Defaults secure_path="/sbin:/bin:/usr/sbin:/usr/bin"'
    validate: 'visudo -cf %s'
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, sudo-hardening]

- name: "Sudo Hardening | Audit sudo configuration"
  ansible.builtin.command: sudo -l
  changed_when: false
  when: _turtini_run_control | bool
  tags: [controls, auth, sudo-hardening, audit]
