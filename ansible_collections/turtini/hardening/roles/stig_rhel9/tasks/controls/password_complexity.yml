---
# Control implementation: Password complexity (pwquality)
# Enforces settings in /etc/security/pwquality.conf on RHEL 9

- name: "Password Complexity | Verify pwquality.conf exists"
  ansible.builtin.stat:
    path: /etc/security/pwquality.conf
  register: turtini_pwquality_conf
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Fail if pwquality.conf is missing"
  ansible.builtin.assert:
    that:
      - turtini_pwquality_conf.stat.exists
    fail_msg: >-
      /etc/security/pwquality.conf was not found.
      This role expects RHEL 9-style pwquality configuration.
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Validate inputs"
  ansible.builtin.assert:
    that:
      - turtini_stig_pwquality_minlen is number
      - turtini_stig_pwquality_minclass is number
      - turtini_stig_pwquality_dcredit is number
      - turtini_stig_pwquality_ucredit is number
      - turtini_stig_pwquality_lcredit is number
      - turtini_stig_pwquality_ocredit is number
      - (turtini_stig_pwquality_minlen | int) >= 8
      - (turtini_stig_pwquality_minclass | int) >= 1
    fail_msg: >-
      Invalid pwquality inputs.
      Got: minlen={{ turtini_stig_pwquality_minlen }},
           minclass={{ turtini_stig_pwquality_minclass }},
           dcredit={{ turtini_stig_pwquality_dcredit }},
           ucredit={{ turtini_stig_pwquality_ucredit }},
           lcredit={{ turtini_stig_pwquality_lcredit }},
           ocredit={{ turtini_stig_pwquality_ocredit }}.
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Audit current pwquality settings"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*(minlen|minclass|dcredit|ucredit|lcredit|ocredit)\b' /etc/security/pwquality.conf || true
  args:
    executable: /bin/bash
  register: turtini_pwquality_current
  changed_when: false
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Report current settings"
  ansible.builtin.debug:
    msg:
      - "Current /etc/security/pwquality.conf settings:"
      - "{{ (turtini_pwquality_current.stdout | default('')) | trim }}"
      - "Target:"
      - "  minlen={{ turtini_stig_pwquality_minlen | int }}"
      - "  minclass={{ turtini_stig_pwquality_minclass | int }}"
      - "  dcredit={{ turtini_stig_pwquality_dcredit | int }}"
      - "  ucredit={{ turtini_stig_pwquality_ucredit | int }}"
      - "  lcredit={{ turtini_stig_pwquality_lcredit | int }}"
      - "  ocredit={{ turtini_stig_pwquality_ocredit | int }}"
  when: turtini_stig_audit_only | bool
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Ensure pwquality parameters are set"
  ansible.builtin.lineinfile:
    path: /etc/security/pwquality.conf
    regexp: '^\s*{{ item.key }}\b.*$'
    line: "{{ item.key }} = {{ item.value }}"
    create: false
  loop:
    - { key: "minlen", value: "{{ turtini_stig_pwquality_minlen | int }}" }
    - { key: "minclass", value: "{{ turtini_stig_pwquality_minclass | int }}" }
    - { key: "dcredit", value: "{{ turtini_stig_pwquality_dcredit | int }}" }
    - { key: "ucredit", value: "{{ turtini_stig_pwquality_ucredit | int }}" }
    - { key: "lcredit", value: "{{ turtini_stig_pwquality_lcredit | int }}" }
    - { key: "ocredit", value: "{{ turtini_stig_pwquality_ocredit | int }}" }
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Audit final pwquality settings"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*(minlen|minclass|dcredit|ucredit|lcredit|ocredit)\b' /etc/security/pwquality.conf || true
  args:
    executable: /bin/bash
  register: turtini_pwquality_final
  changed_when: false
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Report final settings (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/security/pwquality.conf settings:"
      - "{{ (turtini_pwquality_final.stdout | default('')) | trim }}"
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-complexity, audit]

