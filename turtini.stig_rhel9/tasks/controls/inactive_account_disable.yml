---
# Control implementation: Inactive account disable (useradd defaults)
# Enforces INACTIVE in /etc/default/useradd

- name: "Inactive Account Disable | Verify /etc/default/useradd exists"
  ansible.builtin.stat:
    path: /etc/default/useradd
  register: turtini_useradd_defaults
  tags: [controls, auth, inactive-account-disable]

- name: "Inactive Account Disable | Fail if /etc/default/useradd is missing"
  ansible.builtin.assert:
    that:
      - turtini_useradd_defaults.stat.exists
    fail_msg: >-
      /etc/default/useradd was not found. This file is expected on RHEL 9.
  tags: [controls, auth, inactive-account-disable]

- name: "Inactive Account Disable | Validate inputs"
  ansible.builtin.assert:
    that:
      - turtini_stig_useradd_inactive_days is number
      - (turtini_stig_useradd_inactive_days | int) >= 0
    fail_msg: >-
      Invalid inactive-days input.
      Got: turtini_stig_useradd_inactive_days={{ turtini_stig_useradd_inactive_days }}.
      Expected a non-negative integer (e.g., 35).
  tags: [controls, auth, inactive-account-disable]

- name: "Inactive Account Disable | Audit current INACTIVE value"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*INACTIVE\s*=' /etc/default/useradd || true
  args:
    executable: /bin/bash
  register: turtini_useradd_inactive_current
  changed_when: false
  tags: [controls, auth, inactive-account-disable, audit]

- name: "Inactive Account Disable | Report current value"
  ansible.builtin.debug:
    msg:
      - "Current /etc/default/useradd INACTIVE setting:"
      - "{{ (turtini_useradd_inactive_current.stdout | default('')) | trim }}"
      - "Target: INACTIVE={{ turtini_stig_useradd_inactive_days | int }}"
  when: turtini_stig_audit_only | bool
  tags: [controls, auth, inactive-account-disable, audit]

- name: "Inactive Account Disable | Ensure INACTIVE is set"
  ansible.builtin.lineinfile:
    path: /etc/default/useradd
    regexp: '^\s*INACTIVE\s*='
    line: "INACTIVE={{ turtini_stig_useradd_inactive_days | int }}"
    create: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, inactive-account-disable]

- name: "Inactive Account Disable | Audit final INACTIVE value"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*INACTIVE\s*=' /etc/default/useradd || true
  args:
    executable: /bin/bash
  register: turtini_useradd_inactive_final
  changed_when: false
  tags: [controls, auth, inactive-account-disable, audit]

- name: "Inactive Account Disable | Report final value (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/default/useradd INACTIVE setting:"
      - "{{ (turtini_useradd_inactive_final.stdout | default('')) | trim }}"
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, inactive-account-disable, audit]
