---
# Control: Password Aging (login.defs)
# Enforces PASS_MAX_DAYS, PASS_MIN_DAYS, PASS_WARN_AGE

- name: "Control Metadata | password-aging"
  ansible.builtin.set_fact:
    turtini_control_meta:
      id: "password-aging"
      title: "Password aging policy is enforced via /etc/login.defs"
      stig:
        # TODO: map to exact DISA STIG Rule IDs / Vuln IDs for RHEL 9
        rules: []
      severity: "medium"
      cci:
        # TODO: map to CCIs once STIG IDs are finalized
        - "TBD"
      nist:
        # Common mapping for password policy controls; refine per STIG mapping
        - "IA-5"
      rationale: >-
        Password aging reduces the window of exposure if credentials are compromised
        and supports baseline account hygiene requirements.
      check: >-
        Review /etc/login.defs and confirm PASS_MAX_DAYS, PASS_MIN_DAYS, and
        PASS_WARN_AGE meet the site policy.
      fix: >-
        Set PASS_MAX_DAYS, PASS_MIN_DAYS, and PASS_WARN_AGE in /etc/login.defs to
        values required by the site policy.
      implementation: >-
        This control audits current values and, when apply mode is enabled, updates
        /etc/login.defs to match role variables.
      notes:
        - "Applies primarily to new password changes; existing accounts may require chage per site policy."
        - "Kept intentionally minimal and safe for early versions."

- name: "Password Aging | Metadata (verbose)"
  ansible.builtin.debug:
    var: turtini_control_meta
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-aging, meta]

- name: "Password Aging | Validate inputs"
  ansible.builtin.assert:
    that:
      - turtini_stig_pass_max_days is number
      - turtini_stig_pass_min_days is number
      - turtini_stig_pass_warn_age is number
      - (turtini_stig_pass_max_days | int) > 0
      - (turtini_stig_pass_min_days | int) >= 0
      - (turtini_stig_pass_warn_age | int) >= 0
      - (turtini_stig_pass_min_days | int) <= (turtini_stig_pass_max_days | int)
    fail_msg: >-
      Invalid password aging inputs. Ensure values are integers and sensible.
      Got: PASS_MAX_DAYS={{ turtini_stig_pass_max_days }},
           PASS_MIN_DAYS={{ turtini_stig_pass_min_days }},
           PASS_WARN_AGE={{ turtini_stig_pass_warn_age }}.
  tags: [controls, auth, password-aging]

- name: "Password Aging | Audit current /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(#\s*)?(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_current
  changed_when: false
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report current values"
  ansible.builtin.debug:
    msg:
      - "Current /etc/login.defs settings:"
      - "{{ (turtini_login_defs_current.stdout | default('')) | trim }}"
      - "Target settings: PASS_MAX_DAYS={{ turtini_stig_pass_max_days }}, PASS_MIN_DAYS={{ turtini_stig_pass_min_days }}, PASS_WARN_AGE={{ turtini_stig_pass_warn_age }}"
  when: turtini_stig_audit_only | bool
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Ensure PASS_MAX_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_MAX_DAYS\b.*$'
    line: "PASS_MAX_DAYS   {{ turtini_stig_pass_max_days | int }}"
    create: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_MIN_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_MIN_DAYS\b.*$'
    line: "PASS_MIN_DAYS   {{ turtini_stig_pass_min_days | int }}"
    create: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_WARN_AGE is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_WARN_AGE\b.*$'
    line: "PASS_WARN_AGE   {{ turtini_stig_pass_warn_age | int }}"
    create: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Audit final /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_final
  changed_when: false
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report final values (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/login.defs settings:"
      - "{{ (turtini_login_defs_final.stdout | default('')) | trim }}"
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-aging, audit]
