---
# Password aging policy (login.defs)
# Enforces PASS_MAX_DAYS, PASS_MIN_DAYS, PASS_WARN_AGE
#
# Notes:
# - Applies to *new* passwords by default; existing accounts may need a separate
#   remediation step (chage) depending on your environment/policy.
# - Kept intentionally minimal for v0.1 (safe-by-default).

- name: "Password Aging | Audit current /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_current
  changed_when: false
  when: _turtini_run_control | bool
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report current values"
  ansible.builtin.debug:
    msg:
      - "Current /etc/login.defs settings:"
      - "{{ (turtini_login_defs_current.stdout | default('')) | trim }}"
      - "Target settings: PASS_MAX_DAYS={{ turtini_stig_pass_max_days }}, PASS_MIN_DAYS={{ turtini_stig_pass_min_days }}, PASS_WARN_AGE={{ turtini_stig_pass_warn_age }}"
  when:
    - _turtini_run_control | bool
    - turtini_stig_audit_only | bool
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Ensure PASS_MAX_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS\s+'
    line: "PASS_MAX_DAYS   {{ turtini_stig_pass_max_days }}"
    create: false
    backrefs: false
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_MIN_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MIN_DAYS\s+'
    line: "PASS_MIN_DAYS   {{ turtini_stig_pass_min_days }}"
    create: false
    backrefs: false
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_WARN_AGE is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_WARN_AGE\s+'
    line: "PASS_WARN_AGE   {{ turtini_stig_pass_warn_age }}"
    create: false
    backrefs: false
  when:
    - _turtini_run_control | bool
    - turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Audit final /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_final
  changed_when: false
  when: _turtini_run_control | bool
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report final values (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/login.defs settings:"
      - "{{ (turtini_login_defs_final.stdout | default('')) | trim }}"
  when:
    - _turtini_run_control | bool
    - turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-aging, audit]
