---
# Password aging policy (login.defs)
# Enforces PASS_MAX_DAYS, PASS_MIN_DAYS, PASS_WARN_AGE
#
# Notes:
# - Applies to new password changes by default. Existing users may require
#   remediation (e.g., chage) depending on environment policy.
# - Kept intentionally minimal and safe for early versions.

- name: "Password Aging | Validate inputs"
  ansible.builtin.assert:
    that:
      - turtini_stig_pass_max_days is number
      - turtini_stig_pass_min_days is number
      - turtini_stig_pass_warn_age is number
      - (turtini_stig_pass_max_days | int) > 0
      - (turtini_stig_pass_min_days | int) >= 0
      - (turtini_stig_pass_warn_age | int) >= 0
      - (turtini_stig_pass_min_days | int) <= (turtini_stig_pass_max_days | int)
    fail_msg: >-
      Invalid password aging inputs. Ensure values are integers and sensible.
      Got: PASS_MAX_DAYS={{ turtini_stig_pass_max_days }},
           PASS_MIN_DAYS={{ turtini_stig_pass_min_days }},
           PASS_WARN_AGE={{ turtini_stig_pass_warn_age }}.

- name: "Password Aging | Audit current /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(#\s*)?(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_current
  changed_when: false
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report current values"
  ansible.builtin.debug:
    msg:
      - "Current /etc/login.defs settings:"
      - "{{ (turtini_login_defs_current.stdout | default('')) | trim }}"
      - "Target settings: PASS_MAX_DAYS={{ turtini_stig_pass_max_days }}, PASS_MIN_DAYS={{ turtini_stig_pass_min_days }}, PASS_WARN_AGE={{ turtini_stig_pass_warn_age }}"
  when: turtini_stig_audit_only | bool
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Ensure PASS_MAX_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_MAX_DAYS\b.*$'
    line: "PASS_MAX_DAYS   {{ turtini_stig_pass_max_days | int }}"
    insertbefore: '^#\s*Password aging controls'
    create: false
    backrefs: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_MIN_DAYS is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_MIN_DAYS\b.*$'
    line: "PASS_MIN_DAYS   {{ turtini_stig_pass_min_days | int }}"
    insertbefore: '^#\s*Password aging controls'
    create: false
    backrefs: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Ensure PASS_WARN_AGE is set"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^(#\s*)?PASS_WARN_AGE\b.*$'
    line: "PASS_WARN_AGE   {{ turtini_stig_pass_warn_age | int }}"
    insertbefore: '^#\s*Password aging controls'
    create: false
    backrefs: false
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-aging]

- name: "Password Aging | Audit final /etc/login.defs values"
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)\b' /etc/login.defs || true
  args:
    executable: /bin/bash
  register: turtini_login_defs_final
  changed_when: false
  tags: [controls, auth, password-aging, audit]

- name: "Password Aging | Report final values (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/login.defs settings:"
      - "{{ (turtini_login_defs_final.stdout | default('')) | trim }}"
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-aging, audit]
