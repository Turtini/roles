---
# Control: Password Complexity (pwquality)
# Configured via /etc/security/pwquality.conf

- name: "Control Metadata | password-complexity"
  ansible.builtin.set_fact:
    turtini_control_meta:
      id: "password-complexity"
      title: "Password complexity is enforced using pwquality"
      stig:
        rules: []   # TODO: map to exact RHEL 9 STIG Rule / Vuln IDs
      severity: "medium"
      cci:
        - "TBD"
      nist:
        - "IA-5"
      rationale: >-
        Enforcing password complexity reduces the likelihood of successful
        brute-force and credential-guessing attacks.
      check: >-
        Review /etc/security/pwquality.conf and confirm complexity parameters
        meet site policy.
      fix: >-
        Configure pwquality parameters in /etc/security/pwquality.conf.
      implementation: >-
        This control audits current pwquality settings and, when apply mode is
        enabled, enforces minimum length and character class requirements.
      notes:
        - "This control relies on authselect-managed PAM configuration."
        - "Applies to new password changes."

- name: "Password Complexity | Metadata (verbose)"
  ansible.builtin.debug:
    var: turtini_control_meta
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-complexity, meta]

- name: "Password Complexity | Verify pwquality.conf exists"
  ansible.builtin.stat:
    path: /etc/security/pwquality.conf
  register: turtini_pwquality_conf
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Fail if pwquality.conf is missing"
  ansible.builtin.assert:
    that:
      - turtini_pwquality_conf.stat.exists
    fail_msg: >-
      /etc/security/pwquality.conf was not found.
      This role expects RHEL 9-style pwquality configuration.
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Validate inputs"
  ansible.builtin.assert:
    that:
      - turtini_stig_pwquality_minlen is number
      - turtini_stig_pwquality_minclass is number
    fail_msg: >-
      Invalid pwquality inputs detected.
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Audit current pwquality settings"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*(minlen|minclass|dcredit|ucredit|lcredit|ocredit)\b' /etc/security/pwquality.conf || true
  args:
    executable: /bin/bash
  register: turtini_pwquality_current
  changed_when: false
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Report current settings"
  ansible.builtin.debug:
    msg:
      - "Current /etc/security/pwquality.conf settings:"
      - "{{ (turtini_pwquality_current.stdout | default('')) | trim }}"
  when: turtini_stig_audit_only | bool
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Ensure pwquality parameters are set"
  ansible.builtin.lineinfile:
    path: /etc/security/pwquality.conf
    regexp: '^\s*{{ item.key }}\b.*$'
    line: "{{ item.key }} = {{ item.value }}"
    create: false
  loop:
    - { key: "minlen", value: "{{ turtini_stig_pwquality_minlen }}" }
    - { key: "minclass", value: "{{ turtini_stig_pwquality_minclass }}" }
    - { key: "dcredit", value: "{{ turtini_stig_pwquality_dcredit }}" }
    - { key: "ucredit", value: "{{ turtini_stig_pwquality_ucredit }}" }
    - { key: "lcredit", value: "{{ turtini_stig_pwquality_lcredit }}" }
    - { key: "ocredit", value: "{{ turtini_stig_pwquality_ocredit }}" }
  when: turtini_stig_apply | bool
  tags: [controls, auth, password-complexity]

- name: "Password Complexity | Audit final pwquality settings"
  ansible.builtin.shell: |
    set -o pipefail
    egrep -n '^\s*(minlen|minclass|dcredit|ucredit|lcredit|ocredit)\b' /etc/security/pwquality.conf || true
  args:
    executable: /bin/bash
  register: turtini_pwquality_final
  changed_when: false
  tags: [controls, auth, password-complexity, audit]

- name: "Password Complexity | Report final settings (verbose)"
  ansible.builtin.debug:
    msg:
      - "Final /etc/security/pwquality.conf settings:"
      - "{{ (turtini_pwquality_final.stdout | default('')) | trim }}"
  when: turtini_stig_preflight_verbose | bool
  tags: [controls, auth, password-complexity, audit]
