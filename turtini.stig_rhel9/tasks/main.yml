---
# Main entrypoint for the role.
# preflight -> selection context -> includes controls.

- name: Include preflight safety checks
  ansible.builtin.include_tasks: preflight.yml
  tags: [preflight]

# --------------------------------------------------------------------
# Control selection context
#
# Goal: compute one boolean that each control can reuse:
#   _turtini_run_control (per-control, computed inline in each include)
#
# Strategy:
# - normalize lists (already done in preflight when enabled)
# - provide safe defaults here too, so controls can reference these vars
#   even when selection is disabled.
# --------------------------------------------------------------------

- name: Initialize control selection defaults (safe)
  ansible.builtin.set_fact:
    _turtini_controls_include: "{{ (turtini_stig_controls_include | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
    _turtini_controls_exclude: "{{ (turtini_stig_controls_exclude | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
    _turtini_tags_include: "{{ (turtini_stig_tags_include | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
    _turtini_tags_exclude: "{{ (turtini_stig_tags_exclude | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
    _turtini_categories_include: "{{ (turtini_stig_categories_include | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
    _turtini_categories_exclude: "{{ (turtini_stig_categories_exclude | default([])) | map('string') | map('trim') | reject('equalto','') | list }}"
  tags: [always]

# --------------------------------------------------------------------
# Controls
#
# Convention: each control is a file under tasks/controls/
# Example naming:
#   tasks/controls/V-12345.yml
#   tasks/controls/V-12346.yml
#
# Each include passes three bits of metadata:
#   _turtini_control_id
#   _turtini_control_tags
#   _turtini_control_categories
#
# Then we compute _turtini_run_control for that specific control
# in the vars: block, so the control file can simply:
#   when: _turtini_run_control
# --------------------------------------------------------------------

- name: Controls | Example placeholder (copy this block per control)
  ansible.builtin.include_tasks: controls/example_control.yml
  vars:
    _turtini_control_id: "V-00000"
    _turtini_control_tags: ["example", "stig"]
    _turtini_control_categories: ["example"]
    _turtini_run_control: >-
      {{
        (
          not (turtini_stig_enable_control_selection | bool)
        )
        or
        (
          (
            (_turtini_controls_include | length == 0) or (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0) or (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([])) | intersect(_turtini_tags_include) | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([])) | i_
