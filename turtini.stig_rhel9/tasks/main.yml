---
# Main task entrypoint for turtini.stig_rhel9
# Order matters:
# 1. Preflight safety checks
# 2. Normalize control selection inputs
# 3. Execute controls (opt-in, safe-by-default)

- name: Include preflight safety checks
  ansible.builtin.include_tasks: preflight.yml
  tags: [preflight]

- name: Initialize control selection defaults (safe)
  ansible.builtin.set_fact:
    _turtini_controls_include: >-
      {{
        (turtini_stig_controls_include | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
    _turtini_controls_exclude: >-
      {{
        (turtini_stig_controls_exclude | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
    _turtini_tags_include: >-
      {{
        (turtini_stig_tags_include | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
    _turtini_tags_exclude: >-
      {{
        (turtini_stig_tags_exclude | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
    _turtini_categories_include: >-
      {{
        (turtini_stig_categories_include | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
    _turtini_categories_exclude: >-
      {{
        (turtini_stig_categories_exclude | default([]))
        | map('string') | map('trim')
        | reject('equalto', '')
        | list
      }}
  tags: [always]

# ==========================================================
# Controls
# ==========================================================

- name: Controls | Password aging | Metadata
  ansible.builtin.include_tasks: controls/password_aging_meta.yml
  tags:
    - controls
    - auth
    - password-aging
    - meta

- name: Controls | Password aging (login.defs)
  ansible.builtin.include_tasks: controls/password_aging.yml
  vars:
    _turtini_control_id: "password-aging"
    _turtini_control_tags:
      - auth
      - password-aging
    _turtini_control_categories:
      - auth
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_include)
              | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_exclude)
              | length == 0)
          )
          and
          (
            (_turtini_categories_include | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_include)
              | length > 0)
          )
          and
          (
            (_turtini_categories_exclude | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_exclude)
              | length == 0)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - auth
    - password-aging

- name: Controls | Account lockout | Metadata
  ansible.builtin.include_tasks: controls/account_lockout_meta.yml
  tags:
    - controls
    - auth
    - account-lockout
    - meta

- name: Controls | Account lockout (pam_faillock)
  ansible.builtin.include_tasks: controls/account_lockout.yml
  vars:
    _turtini_control_id: "account-lockout"
    _turtini_control_tags:
      - auth
      - account-lockout
    _turtini_control_categories:
      - auth
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_include)
              | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_exclude)
              | length == 0)
          )
          and
          (
            (_turtini_categories_include | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_include)
              | length > 0)
          )
          and
          (
            (_turtini_categories_exclude | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_exclude)
              | length == 0)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - auth
    - account-lockout

- name: Controls | Inactive account disable | Metadata
  ansible.builtin.include_tasks: controls/inactive_account_disable_meta.yml
  tags:
    - controls
    - auth
    - inactive-account-disable
    - meta

- name: Controls | Inactive account disable (/etc/default/useradd)
  ansible.builtin.include_tasks: controls/inactive_account_disable.yml
  vars:
    _turtini_control_id: "inactive-account-disable"
    _turtini_control_tags:
      - auth
      - inactive-account-disable
    _turtini_control_categories:
      - auth
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_include)
              | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_exclude)
              | length == 0)
          )
          and
          (
            (_turtini_categories_include | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_include)
              | length > 0)
          )
          and
          (
            (_turtini_categories_exclude | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_exclude)
              | length == 0)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - auth
    - inactive-account-disable

- name: Controls | Password complexity | Metadata
  ansible.builtin.include_tasks: controls/password_complexity_meta.yml
  tags:
    - controls
    - auth
    - password-complexity
    - meta

- name: Controls | Password complexity (pwquality)
  ansible.builtin.include_tasks: controls/password_complexity.yml
  vars:
    _turtini_control_id: "password-complexity"
    _turtini_control_tags:
      - auth
      - password-complexity
    _turtini_control_categories:
      - auth
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_include)
              | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_exclude)
              | length == 0)
          )
          and
          (
            (_turtini_categories_include | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_include)
              | length > 0)
          )
          and
          (
            (_turtini_categories_exclude | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_exclude)
              | length == 0)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - auth
    - password-complexity

- name: Controls | SSH hardening | Metadata
  ansible.builtin.include_tasks: controls/ssh_hardening_meta.yml
  tags:
    - controls
    - auth
    - ssh-hardening
    - meta

- name: Controls | SSH hardening (sshd)
  ansible.builtin.include_tasks: controls/ssh_hardening.yml
  vars:
    _turtini_control_id: "ssh-hardening"
    _turtini_control_tags:
      - auth
      - ssh-hardening
    _turtini_control_categories:
      - auth
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
          and
          (
            (_turtini_tags_include | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_include)
              | length > 0)
          )
          and
          (
            (_turtini_tags_exclude | length == 0)
            or
            ((_turtini_control_tags | default([]))
              | intersect(_turtini_tags_exclude)
              | length == 0)
          )
          and
          (
            (_turtini_categories_include | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_include)
              | length > 0)
          )
          and
          (
            (_turtini_categories_exclude | length == 0)
            or
            ((_turtini_control_categories | default([]))
              | intersect(_turtini_categories_exclude)
              | length == 0)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - auth
    - ssh-hardening

- name: Controls | Sudo hardening | Metadata
  ansible.builtin.include_tasks: controls/sudo_hardening_meta.yml
  tags: [controls, auth, sudo-hardening, meta]

- name: Controls | Sudo hardening
  ansible.builtin.include_tasks: controls/sudo_hardening.yml
  vars:
    _turtini_control_id: "sudo-hardening"
    _turtini_control_tags: [auth, sudo-hardening]
    _turtini_control_categories: [auth]
    _turtini_run_control: "{{ not turtini_stig_enable_control_selection | bool
      or _turtini_control_id in _turtini_controls_include }}"
  when: _turtini_run_control | bool
  tags: [controls, auth, sudo-hardening]
  
- name: Controls | FIPS mode verification | Metadata
  ansible.builtin.include_tasks: controls/fips_mode_meta.yml
  tags: [controls, fips, meta]

- name: Controls | FIPS mode verification
  ansible.builtin.include_tasks: controls/fips_mode.yml
  vars:
    _turtini_control_id: "fips-mode-verification"
    _turtini_control_tags: [fips, crypto]
    _turtini_control_categories: [crypto]
    _turtini_run_control: true
  tags: [controls, fips, audit]

- name: Controls | USB storage disable | Metadata
  ansible.builtin.include_tasks: controls/usb_storage_disable_meta.yml
  tags:
    - controls
    - hardware
    - usb
    - meta

- name: Controls | USB storage disable
  ansible.builtin.include_tasks: controls/usb_storage_disable.yml
  vars:
    _turtini_control_id: "usb-storage-disable"
    _turtini_control_tags:
      - hardware
      - usb
    _turtini_control_categories:
      - hardware
    _turtini_run_control: >-
      {{
        (not (turtini_stig_enable_control_selection | bool))
        or
        (
          (
            (_turtini_controls_include | length == 0)
            or
            (_turtini_control_id in _turtini_controls_include)
          )
          and
          (
            (_turtini_controls_exclude | length == 0)
            or
            (_turtini_control_id not in _turtini_controls_exclude)
          )
        )
      }}
  when: _turtini_run_control | bool
  tags:
    - controls
    - hardware
    - usb

